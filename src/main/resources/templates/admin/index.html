<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"> <head th:replace="~{admin/fragments/head :: head}"></head>

<body class="bg-theme bg-theme2">

<div id="wrapper">

    <div th:replace="~{admin/fragments/sidebar :: sidebar}"></div>
    <header th:replace="~{admin/fragments/header :: header}"></header>
    <div class="clearfix"></div>

    <div class="content-wrapper">
        <div class="container-fluid">

            <div class="card mt-3">
                <div class="card-content"> <div class="row row-group m-0"> <div class="col-12 col-lg-6 col-xl-3 border-light">
                    <div class="card-body"> <h5 class="text-white mb-0" th:text="${summary.totalOrders}">0</h5>
                        <div class="progress my-3" style="height:3px;">
                            <div class="progress-bar" style="width:55%"></div>
                        </div>
                        <p class="mb-0 text-white small-font">Pending Orders</p> </div>
                </div>
                    <div class="col-12 col-lg-6 col-xl-3 border-light">
                        <div class="card-body"> <h5 class="text-white mb-0" th:text="${'$' + #numbers.formatDecimal(summary.totalRevenue, 1, 'COMMA', 2, 'POINT')}">$0.00</h5>
                            <div class="progress my-3" style="height:3px;">
                                <div class="progress-bar" style="width:55%"></div>
                            </div>
                            <p class="mb-0 text-white small-font">Total Revenue (Confirmed)</p> </div>
                    </div>
                    <div class="col-12 col-lg-6 col-xl-3 border-light">
                        <div class="card-body"> <h5 class="text-white mb-0" th:text="${summary.totalUsers}">0</h5>
                            <div class="progress my-3" style="height:3px;">
                                <div class="progress-bar" style="width:55%"></div>
                            </div>
                            <p class="mb-0 text-white small-font">Total Users</p> </div>
                    </div>
                    <div class="col-12 col-lg-6 col-xl-3 border-light">
                        <div class="card-body"> <h5 class="text-white mb-0" th:text="${summary.unreadMessages}">0</h5>
                            <div class="progress my-3" style="height:3px;">
                                <div class="progress-bar" style="width:55%"></div>
                            </div>
                            <p class="mb-0 text-white small-font">Unread Messages</p> </div>
                    </div>
                </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12 col-lg-8 col-xl-8">
                    <div class="card">
                        <div class="card-header">Site Traffic
                            <div class="card-action">
                                <div class="dropdown">
                                    <a href="javascript:void();" class="dropdown-toggle dropdown-toggle-nocaret" data-toggle="dropdown">
                                        <i class="icon-options"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-right">
                                        <a class="dropdown-item" href="javascript:void();">Action</a>
                                        <a class="dropdown-item" href="javascript:void();">Another action</a>
                                        <a class="dropdown-item" href="javascript:void();">Something else here</a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item" href="javascript:void();">Separated link</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <ul class="list-inline">
                                <li class="list-inline-item"><i class="fa fa-circle mr-2 text-white"></i>Monthly Revenue</li>
                            </ul>
                            <div class="chart-container-1">
                                <canvas id="chart1"></canvas>
                            </div>
                        </div>

                        <div class="row m-0 row-group text-center border-top border-light-3">
                            <div class="col-12 col-lg-4">
                                <div class="p-3">
                                    <h5 class="mb-0">45.87M</h5>
                                    <small class="mb-0">Overall Visitor <span> <i class="fa fa-arrow-up"></i> 2.43%</span></small>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div class="p-3">
                                    <h5 class="mb-0">15:48</h5>
                                    <small class="mb-0">Visitor Duration <span> <i class="fa fa-arrow-up"></i> 12.65%</span></small>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div class="p-3">
                                    <h5 class="mb-0">245.65</h5>
                                    <small class="mb-0">Pages/Visit <span> <i class="fa fa-arrow-up"></i> 5.62%</span></small>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="col-12 col-lg-4 col-xl-4">
                    <div class="card">
                        <div class="card-header" id="weeklySalesChartTitle">Weekly sales
                            <div class="card-action">
                                <div class="dropdown">
                                    <a href="javascript:void();" class="dropdown-toggle dropdown-toggle-nocaret" data-toggle="dropdown">
                                        <i class="icon-options"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-right">
                                        <a class="dropdown-item" href="javascript:void();">Action</a>
                                        <a class="dropdown-item" href="javascript:void();">Another action</a>
                                        <a class="dropdown-item" href="javascript:void();">Something else here</a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item" href="javascript:void();">Separated link</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container-2">
                                <canvas id="chart2"></canvas>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table align-items-center">
                                <tbody id="weeklySalesTableBody">
                                <tr>
                                    <td><i class="fa fa-circle text-white mr-2"></i> Loading...</td>
                                    <td>...</td>
                                    <td>...</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="overlay toggle-menu"></div>
        </div>
    </div><a href="javaScript:void();" class="back-to-top"><i class="fa fa-angle-double-up"></i> </a>
    <footer th:replace="~{admin/fragments/footer :: footer}"></footer>
</div><div th:replace="~{admin/fragments/script :: script}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/

    // Hàm tạo màu ngẫu nhiên cho biểu đồ tròn
    function getRandomColor() {
        var letters = '0123456789ABCDEF';
        var color = '#';
        for (var i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    document.addEventListener("DOMContentLoaded", function() {

        // 1. Xử lý Biểu đồ Line (Doanh thu theo tháng)
        var ctx1 = document.getElementById("chart1");
        if (ctx1) {
            ctx1.getContext("2d"); // Lấy context

            fetch('/api/dashboard/monthly-revenue')
                .then(response => response.json())
                .then(apiData => {
                    let monthlyRevenue = new Array(12).fill(0);
                    apiData.forEach(item => {
                        let monthIndex = item.month - 1;
                        monthlyRevenue[monthIndex] = item.revenue;
                    });

                    // Tạo biểu đồ MỚI
                    new Chart(ctx1, {
                        type: 'line',
                        data: {
                            labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                            datasets: [{
                                label: "Monthly Revenue (Confirmed)",
                                data: monthlyRevenue,
                                backgroundColor: 'rgba(255, 255, 255, 0.12)',
                                borderColor: 'rgba(255, 255, 255, 0.5)',
                                pointBackgroundColor: '#fff',
                                fill: true, // Tô màu nền
                                tension: 0.4
                            }]
                        },
                        options: { // Thêm options để biểu đồ đẹp (giống template)
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { ticks: { color: 'rgba(255,255,255,0.7)' }, grid: { display: false } },
                                y: { ticks: { color: 'rgba(255,255,255,0.7)' }, grid: { color: 'rgba(255,255,255,0.8)' } }
                            }
                        }
                    });
                })
                .catch(error => console.error('Error fetching monthly revenue:', error));
        }

        // 2. Xử lý Biểu đồ Tròn (Tỷ lệ loại phòng)
        var chartTitleEl = document.getElementById("weeklySalesChartTitle");
        if(chartTitleEl) {
            chartTitleEl.innerText = "Room Type Popularity";
        }

        var ctx2 = document.getElementById("chart2");
        if (ctx2) {
            ctx2.getContext("2d");

            fetch('/api/dashboard/room-type-popularity')
                .then(response => response.json())
                .then(apiData => {
                    let labels = [];
                    let counts = [];
                    let colors = [];

                    apiData.forEach(item => {
                        labels.push(item.roomType);
                        counts.push(item.count);
                        colors.push(getRandomColor()); // Tạo màu ngẫu nhiên
                    });

                    // Tạo biểu đồ MỚI
                    new Chart(ctx2, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: counts,
                                backgroundColor: colors,
                                hoverBackgroundColor: colors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } }
                        }
                    });

                    updateRoomTypeTable(apiData, colors); // Cập nhật bảng
                })
                .catch(error => console.error('Error fetching room type popularity:', error));
        }

        function updateRoomTypeTable(apiData, colors) {
            let tableBody = document.querySelector("#weeklySalesTableBody");
            if (!tableBody) return;

            tableBody.innerHTML = ""; // Xóa dữ liệu cũ
            let total = apiData.reduce((sum, item) => sum + Number(item.count), 0);

            apiData.forEach((item, index) => {
                let percentage = (total > 0) ? ((item.count / total) * 100).toFixed(0) : 0;
                let color = colors[index] || '#ffffff'; // Lấy màu tương ứng

                let row = `
                    <tr>
                       <td><i class="fa fa-circle mr-2" style="color: ${color}"></i> ${item.roomType}</td>
                       <td>${item.count} bookings</td>
                       <td>+${percentage}%</td>
                     </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
    });
    /*]]>*/
</script>

<form th:action="@{/logout}" method="post" id="logoutForm" style="display: none;"></form>
</body>
</html>